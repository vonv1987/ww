# 掌上办移动应用部署流程

## 环境准备

操作系统 | Web服务|Docker版本
-----------|-----------|-----------
Ubuntu 16.04 LTS|Nginx 1.6 以上|1.11 以上

## 部署步骤

#### 1. 安装 Ubuntu 16.04 LTS Server
#### 2. 安装 Docker
#### 3. 部署 Docker Nginx容器
#### 4. 相关文件拷贝至相关对应目录
#### 5. 启动Nginx容器



## 安装 Ubuntu 16.04 LTS Server

- Ubuntu Server 介绍参考: https://help.ubuntu.com/lts/serverguide/index.html

- Ubuntu Server 安装参考: http://www.360doc.com/content/17/0222/11/17572791_631069401.shtml

- Linux 常用命令参考: https://www.runoob.com/linux/linux-command-manual.html

## 安装 Docker

- 什么是Docker? 了解Docker参考: http://www.docker.org.cn/book/docker/what-is-docker-16.html

- Docker 安装采用离线安装方式，上传安装脚本和安装包文件至服务器`/tmp/`目录和`/opt/`目录后，可以执行`./install_docker.sh`直接一键安装docker


> **注意：** 在**安装之前**将`app.tar.gz`文件上传至服务器`/tmp/`目录下，将`nginx_docker-compose.tar.gz`文件上传至服务器`/opt/`目录下。


- #### 登陆Ubuntu服务器执行docker安装脚本

```
cd /tmp/
tar -xzf app.tar.gz
chmod +x install_*
./install_docker.sh 
```

> **当出现:**  INFO[0009] API listen on /var/run/docker.sock 提示时候按换行键（Enter）


## 部署Docker Nginx容器

> 安装之前确保服务器上`80、443` 端口没有被占用

```
cd /tmp/
./install_nginx.sh $1

```

> 备注：$1 参数代表已成功解析用来下载APP的域名地址，例如使用 server.propersoft.cn  为下载APP域名，执行 `./install_nginx.sh server.propersoft.cn`



## 相关文件拷贝至相关对应目录

将研发提供的`index.html、css、img`等静态资源文件及相关app包文件上传至服务器的`/opt/nginx/app/app/`目录下。

将申请下来的SSL证书文件改好名称上传至`/opt/nginx/`目录下

> 备注：将证书以`.crt`或者`.pem` 结尾的文件名改名为和域名相同的名称，将证书私钥文件以`.key`结尾的文件改名为域名名称+`.key`

> 例如：`server.propersoft.cn`域名申请下来的证书文件名为`xxx.crt`和私钥`xxx.key`文件，则必须将`xxx.crt`改名为`server.propersoft.cn`，`xxx.key`改名为`server.propersoft.cn.key`

## 启动Nginx容器

```
cd /opt/
docker-compose up -d nginx_app
```

> 在手机上请求 https://server.propersoft.cn/app/ 测试

- ### 后续维护nginx容器常用命令

```
#重启nginx容器命令
docker restart opt_nginx_app_1

#修改过docker-compose文件后重新构建执行
docker-compose up -d 

```

> **注意：** 如果执行docker命令出现 “Cannot connect to the Docker daemon. Is the docker daemon running on this host? ”
时候执行 `dockerd &` 命令

> **当出现:**  INFO[0009] API listen on /var/run/docker.sock 提示时候按换行键（Enter）即可